<!DOCTYPE html>
<html>
<head>
    <title>Custom Lib</title>
    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <script>
        $(document).ready(function(){

            initialzer();

            function initialzer(){
                //populate topic selector
                getTopics();

                //validate check boxes    
                $("#author_check_box").prop("checked", false); //uncheck all checkboxes
                $("#year_check_box").prop("checked", false);
                $("#publisher_check_box").prop("checked", false);
                $("#md5_check_box").prop("checked", false);
                $("#topic_check_box").prop("checked", false);
                $("#topics_list").hide();
                $("#title_check_box").prop("checked", true);
            }

            function getTopics(){
                $.ajax({
                    url:'http://localhost:8096/api/topics',
                    method: 'GET',
                    dataType: 'json',
                    success: function(result){
                        result.forEach(element => {
                            $('#topics_list').append($("<option></option>").attr("value", element.id).text(element.name));           
                        });        

                    },error:function(error, message){
                        alert("cannot access server");
                    } 
                });       
            }

            //search button
            $("#search_btn").click(function(){
                var searchValue = $("#search_field").val();
                if(searchValue != ""){
                    getSearch();
                }
            });

            //download button event    
            $(document).on('click', '#download_btn' , function() {
                var bookId = $(this).closest("tr").find("#book_id").text();
                downloadFile(bookId); 
            });

            $("#topics_list").change(function(){
                var value = $("#topics_list").val();
                $("#search_field").val(value);
            });

            //ceating search json object
            function createSearchJsonObject() {

                var title = false;
                var author = false;
                var year = false;
                var publisher = false;
                var md5 = false;
                var topic = false;

                if ($("#title_check_box").prop("checked") == true) {
                    title = true;
                } else {
                    title = false;
                }

                if ($("#author_check_box").prop("checked") == true) {
                    author = true;
                } else {
                    author = false;
                }

                if ($("#year_check_box").prop("checked") == true) {
                    year = true;
                } else {
                    year = false;
                }

                if ($("#publisher_check_box").prop("checked") == true) {
                    publisher = true;
                } else {
                    publisher = false;
                }

                if ($("#md5_check_box").prop("checked") == true) {
                    md5 = true;
                } else {
                    md5 = false;
                }

                if ($("#topic_check_box").prop("checked") == true) {
                    topic = true;
                } else {
                    topic = false;
                }

                return JSON.stringify({
                    "search":$("#search_field").val().trim(),
                    "title": title,
                    "author": author,
                    "year": year,
                    "publisher": publisher,
                    "topic": topic,
                    "md5": md5,
                    "defaultSearch": false,
                    "page": 0,
                    "size":25,
                    "sort": "ASCENDING"
                });
            }


            //search function
            function getSearch(){

                var count = 0;

                $.ajax({
                    url:'http://localhost:8096/api/search',
                    method: 'POST',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: createSearchJsonObject(),
                    success: function(result){
                        
                        if(result.length > 0){
                            $('#table_body').children('tr').remove();
                            result.forEach(element => {
                                count++;
                                $("#table_body").append(
                                    "<tr>"+
                                    "<td style='display:none' id='book_id'>"+element.id+"</td>"+
                                    "<td>"+count+"</td>"+
                                    "<td>"+element.author+"</td>"+
                                    "<td>"+element.title+"</td>"+
                                    "<td>"+element.description+"</td>"+
                                    "<td>"+element.year+"</td>"+
                                    "<td><button class='btn' id='download_btn'><i class='fa fa-download'></i> Download</button></td>"+
                                    "</tr>"
                                );
                            });
                        }else{
                            $('#table_body').children('tr').remove();
                            $("#table_body").append(
                                "<tr>"+
                                    "<td colspan='6' class='text-center'>No data found</td>"+
                                "</tr>"
                            ); 
                        }

                        //var data = JSON.parse(result); // create an object with the key of the array
                        console.log(result);
                    },error:function(error, message){
                        alert("cannot access server");
                    }
                });
            }
            
            function downloadFile(bookId){
                $.ajax({
                    type: 'GET',
                    url: 'http://localhost:8096/api/download/'+bookId,
                    xhrFields: {
                        responseType: 'blob' // to avoid binary data being mangled on charset conversion
                    },
                    success: function(blob, status, xhr) {
                        // check for a filename
                        var filename = "";
                        var disposition = xhr.getResponseHeader('Content-Disposition');
                        if (disposition && disposition.indexOf('attachment') !== -1) {
                            var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                            var matches = filenameRegex.exec(disposition);
                            if (matches != null && matches[1]) filename = matches[1].replace(/['"]/g, '');
                        }

                        if (typeof window.navigator.msSaveBlob !== 'undefined') {
                            // IE workaround for "HTML7007: One or more blob URLs were revoked by closing the blob for which they were created. These URLs will no longer resolve as the data backing the URL has been freed."
                            window.navigator.msSaveBlob(blob, filename);
                        } else {
                            var URL = window.URL || window.webkitURL;
                            var downloadUrl = URL.createObjectURL(blob);

                            if (filename) {
                                // use HTML5 a[download] attribute to specify filename
                                var a = document.createElement("a");
                                // safari doesn't support this yet
                                if (typeof a.download === 'undefined') {
                                    window.location.href = downloadUrl;
                                } else {
                                    a.href = downloadUrl;
                                    a.download = filename;
                                    document.body.appendChild(a);
                                    a.click();
                                }
                            } else {
                                window.location.href = downloadUrl;
                            }

                            setTimeout(function () { URL.revokeObjectURL(downloadUrl); }, 100); // cleanup
                        }
                    },error:function(error, message){
                        alert("cannot access download server");
                    }
                });
            }

            //check box code
            $("#title_check_box").click(function() {
                $("#author_check_box").prop("checked", false); //uncheck all checkboxes
                $("#year_check_box").prop("checked", false);
                $("#publisher_check_box").prop("checked", false);
                $("#md5_check_box").prop("checked", false);
                $("#topic_check_box").prop("checked", false);
                $("#topics_list").hide();
                $(this).prop("checked", true);  //check the clicked one
            });

            $("#author_check_box").click(function() {
                $("#title_check_box").prop("checked", false); //uncheck all checkboxes
                $("#year_check_box").prop("checked", false);
                $("#publisher_check_box").prop("checked", false);
                $("#md5_check_box").prop("checked", false);
                $("#topic_check_box").prop("checked", false);
                $("#topics_list").hide();
                $(this).prop("checked", true);  //check the clicked one
            });

            $("#year_check_box").click(function() {
                $("#author_check_box").prop("checked", false); //uncheck all checkboxes
                $("#title_check_box").prop("checked", false);
                $("#publisher_check_box").prop("checked", false);
                $("#md5_check_box").prop("checked", false);
                $("#topic_check_box").prop("checked", false);
                $("#topics_list").hide();
                $(this).prop("checked", true);  //check the clicked one
            });

            $("#publisher_check_box").click(function() {
                $("#author_check_box").prop("checked", false); //uncheck all checkboxes
                $("#title_check_box").prop("checked", false);
                $("#year_check_box").prop("checked", false);
                $("#md5_check_box").prop("checked", false);
                $("#topic_check_box").prop("checked", false);
                $("#topics_list").hide();
                $(this).prop("checked", true);  //check the clicked one
            });

            $("#md5_check_box").click(function() {
                $("#author_check_box").prop("checked", false); //uncheck all checkboxes
                $("#year_check_box").prop("checked", false);
                $("#publisher_check_box").prop("checked", false);
                $("#title_check_box").prop("checked", false);
                $("#topic_check_box").prop("checked", false);
                $("#topics_list").hide();
                $(this).prop("checked", true);  //check the clicked one
            });

            $("#topic_check_box").click(function() {
                $("#author_check_box").prop("checked", false); //uncheck all checkboxes
                $("#year_check_box").prop("checked", false);
                $("#publisher_check_box").prop("checked", false);
                $("#md5_check_box").prop("checked", false);
                $("#title_check_box").prop("checked", false);
                $("#topics_list").show();
                $(this).prop("checked", true);  //check the clicked one
            });

        });
    </script>
</head>
<body>
    <h2 class="text-center my-4">BookBank</h2>

    <div class="container d-flex justify-content-center">
        <div class="col-md-12">
            <div class="row d-flex justify-content-center">
                <div class="col-md-9">
                    <input type="text" name="input" class="form-control" placeholder="search...." id="search_field">       
                </div>
                <div class="col-md-3">
                    <input type="submit" name="search" class="btn btn-info" value="search" id="search_btn">
                </div>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="title_check_box">
                        <label class="form-check-label" for="flexSwitchCheckDefault">Title</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="author_check_box" checked>
                        <label class="form-check-label" for="flexSwitchCheckChecked">Author</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="year_check_box">
                        <label class="form-check-label" for="flexSwitchCheckDefault">Year</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="publisher_check_box" checked>
                        <label class="form-check-label" for="flexSwitchCheckChecked">Publisher</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="md5_check_box">
                        <label class="form-check-label" for="flexSwitchCheckDefault">MD5</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="topic_check_box">
                        <label class="form-check-label" for="flexSwitchCheckDefault">Topic</label>
                    </div>
                </div> 
                <div class="col-md-3">
                    <select class="form-select" aria-label="Default select example"  style="margin-top: 3%;" id="topics_list">
                        <option value="">Select topic</option>
                    </select>
                </div>
            </div>
                
            <div class="row">
               <table class="table table-bordered table-striped" id="search_table">
                   <tr>
                       <th>Nu</th>
                       <th>Author</th>
                       <th>Title</th>
                       <th>Description</th>
                       <th>Year</th>
                       <th>File</th>
                   </tr>
                   <tbody id="table_body">

                   </tbody>
                   
               </table>     
            </div>
        </div>

    </div>

</body>

</html>